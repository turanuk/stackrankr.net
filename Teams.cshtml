@{
  WebSecurity.RequireAuthenticatedUser();
  Layout = "~/_SiteLayout.cshtml";
  Page.Title = "Your Teams";

  var db = Database.Open("stackRankR");
  if (IsPost) {
    db.Execute("INSERT INTO Team (Name, OwnerId, Display) VALUES (@0, @1, @2)", Request["newTeamName"], WebSecurity.CurrentUserId, true);
    var teamId = db.GetLastInsertId();
    for (int i = 1; i <= 3; i++) {
      db.Execute("INSERT INTO Ranking (Name, TeamId) VALUES (@0, @1)", i, teamId);
    }
    Response.Redirect("~/ViewTeam/" + teamId);
  }
  var teamQuery = db.Query("SELECT Name, Id, Display FROM Team WHERE OwnerId = @0", WebSecurity.CurrentUserId);
}

@section Scripts {
  <script>
    $(function () {
      $('#newTeamButton').click(function () {
        $("#dialog").dialog({
          modal: true,
          draggable: false,
          resizable: false,
          buttons: {
            "Create": function () {
              if ($('#newTeamName').val() === '') {
                $('.error').show();
              } else {
                document.forms['newTeam'].submit();
                $(this).dialog('close');
              }
            },
            "Cancel": function () {
              $(this).dialog('close');
            }
          },
          open: function () {
            $(this).parent().appendTo($('#newTeam'));
            $('#newTeamName').select();
          }
        });
      });

      $('#newTeamName').keydown(function () {
        $('.error').hide();
      });

      $('.modifyButton').click(function (e) {
        e.preventDefault();
        var modifyButtonDom = $(this);
        var teamId = modifyButtonDom.attr('data-teamId');
        var teamName = modifyButtonDom.attr('data-teamName');
        $("#editTeamDialog").dialog({
          modal: true,
          draggable: false,
          resizable: false,
          buttons: {
            "Update": function () {
              var editTeamName = $('#editTeamName').val();
              if (editTeamName === '') {
                $('.error').show();
              } else {
                $.post('/endpoints/updateteam', { TeamId: teamId, NewTeamName: editTeamName }, function (data) {
                  modifyButtonDom.prev('.teamName').html(editTeamName);
                });
                $(this).dialog('close');
              }
            },
            "Cancel": function () {
              $(this).dialog('close');
            }
          },
          open: function () {
            var thisDialog = $(this);
            $('#editTeamName').val(modifyButtonDom.attr('data-teamName'));
            $('#editTeamName').select();
            $('#editTeamName').keydown(function (e) {
              editTeamName = $('#editTeamName').val();
              if (e.keyCode === 13) {
                $.post('/endpoints/updateteam', { TeamId: teamId, NewTeamName: editTeamName }, function (data) {
                  modifyButtonDom.prev('.teamName').html(editTeamName);
                });
                thisDialog.dialog('close');
              }
            });
            $('#deleteTeam').click(function () {
              if ($(this).html() === 'Sure?') {
                $.post('/endpoints/deleteteam', { TeamId: teamId }, function (data) {
                  modifyButtonDom.parents('.team').fadeOut(50, function () {
                    var undoButton = '<li class="team deletedTeam"><a class="undo" href="javascript:return false" data-teamId="' + teamId + '"><span>Deleted ' + teamName + '.</span><span class="undoButton">Click to Undo</span></a></li>';
                    modifyButtonDom.parents('.team').before(undoButton);
                  });
                  thisDialog.dialog('close');
                });
              } else {
                $(this).html('Sure?');
              }
            });
          },
          close: function () {
            $('#deleteTeam').html('Delete');
            $('#deleteTeam').unbind('click');
            $('#editTeamName').unbind('keydown');
          }
        });
      })
    });
  </script>
}

<div class="contentContainer">
  <img alt="avatar" src="@Gravatar.GetUrl(WebSecurity.CurrentUserName, 120)" class="avatar">
  @if (teamQuery.Count() == 0) {
    <p>You have no teams!</p>
    <div class="medSpacer"></div>
  } else {
    <ul class="teamList">
      @foreach (var team in teamQuery) {
        if (team.Display == true) {
          <li class="team">
            <a href="~/ViewTeam/@team.Id" class="teamName">
              <span class="teamName">@team.Name</span>
              <span class="modifyButton" data-teamId="@team.Id" data-teamName="@team.Name"></span>
            </a>
          </li>
        }
      }
      
    </ul>
  }

  <form method="post" id="newTeam">
    <a href="javascript:return false;" class="linkButton" id="newTeamButton">New Team</a>
    <div id="dialog" title="New Team">
      <p>Enter a name for your new team:</p>
      <input type="text" id="newTeamName" name="newTeamName" class="dialogInput"/>
      <span class="error">*</span>
    </div>
  </form>
</div>

<div id="editTeamDialog" class="dialogContainer" title="Edit Team">
  <p>Enter the new name for this team:</p>
  <input id="editTeamName" type="text" class="dialogInput"/><span class="error">*</span>
  <p>Or click below to delete the team:</p>
  <div class="medSpacer"></div>
  <a id="deleteTeam" href="javascript:return false;" class="linkButton deleteButton">Delete Team</a>
  <div class="largeSpacer"></div>
</div>