@{
  WebSecurity.RequireAuthenticatedUser();
  Layout = "~/_SiteLayout.cshtml";
  Page.Title = "Your Teams";

  var db = Database.Open("stackRankR");
  if (IsPost) {
    db.Execute("INSERT INTO Team (Name, OwnerId) VALUES (@0, @1)", Request["newTeamName"], WebSecurity.CurrentUserId);
    var teamId = db.GetLastInsertId();
    for (int i = 1; i <= 3; i++) {
      db.Execute("INSERT INTO Ranking (Name, TeamId) VALUES (@0, @1)", i, teamId);
    }
    Response.Redirect("~/ViewTeam/" + teamId);
  }
  var teamQuery = db.Query("SELECT Name, Id FROM Team");
}

@section Scripts {
  <script>
    $(function () {
      $('.linkButton').click(function () {
        $("#dialog").dialog({
          modal: true,
          draggable: false,
          resizable: false,
          buttons: {
            "Create": function () {
              if ($('#newTeamName').val() === '') {
                $('.error').show();
              } else {
                document.forms['newTeam'].submit();
                $(this).dialog('close');
              }
            },
            "Cancel": function () {
              $(this).dialog('close');
            }
          },
          open: function () {
            $(this).parent().appendTo($('#newTeam'));
          }
        });
      });

      $('#newTeamName').keydown(function () {
        $('.error').hide();
      });

      $('.modifyButton').click(function (e) {
        e.preventDefault();
        var modifyButtonDom = $(this);
        $("#editTeamDialog").dialog({
          modal: true,
          draggable: false,
          resizable: false,
          buttons: {
            "Update": function () {
              var editTeamName = $('#editTeamName').val();
              if (editTeamName === '') {
                $('.error').show();
              } else {
                $.post('/endpoints/updateteam', { TeamId: modifyButtonDom.attr('data-teamId'), NewTeamName: editTeamName }, function (data) {
                  modifyButtonDom.next('.teamName').html(editTeamName);
                });
                $(this).dialog('close');
              }
            },
            "Cancel": function () {
              $(this).dialog('close');
            }
          },
          open: function () {
            $('#editTeamName').val(modifyButtonDom.attr('data-teamName'));
            $('#editTeamName').select();
          }
        });
      })
    });
  </script>
}

<div class="contentContainer">
  <img alt="avatar" src="@Gravatar.GetUrl(WebSecurity.CurrentUserName, 120)" class="avatar">
  @if (teamQuery.Count() == 0) {
    <p>You have no teams!</p>
    <div class="medSpacer"></div>
  } else {
    <ul class="teamList">
      @foreach (var team in teamQuery) {
        <li class="team">
          <a href="~/ViewTeam/@team.Id" class="teamName">
            <span class="teamName">@team.Name</span>
            <span class="modifyButton" data-teamId="@team.Id" data-teamName="@team.Name"></span>
          </a>
        </li>
      }
    </ul>
  }

  <form method="post" id="newTeam">
    <a href="javascript:return false;" class="linkButton">New Team</a>
    <div id="dialog" title="New Team">
      <p>Enter a name for your new team:</p>
      <input type="text" id="newTeamName" name="newTeamName" class="dialogInput"/>
      <span class="error">*</span>
    </div>
  </form>
</div>

<div id="editTeamDialog" class="dialogContainer" title="Edit Team">
  <p>Enter the new name for this team:</p>
  <input id="editTeamName" type="text" class="dialogInput"/><span class="error">*</span>
  <p>Or click below to delete the team</p>
  <div class="medSpacer"></div>
  <a href="javascript:return false;" class="linkButton">Delete Team</a>
  <div class="largeSpacer"></div>
</div>